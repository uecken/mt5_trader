<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MT5 Trader思考解析 & 売買システム</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
        }
        .header {
            background: #16213e;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        .header h1 {
            font-size: 1.3rem;
            color: #4cc9f0;
        }
        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .control-group label {
            font-size: 0.85rem;
            color: #aaa;
        }
        select, input {
            background: #0f3460;
            border: 1px solid #4cc9f0;
            color: #fff;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        select:focus, input:focus {
            outline: none;
            border-color: #7b2cbf;
        }
        button {
            background: #4cc9f0;
            color: #1a1a2e;
            border: none;
            padding: 8px 20px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover {
            background: #7b2cbf;
            color: #fff;
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        .btn-start {
            background: #26a69a;
        }
        .btn-start:hover {
            background: #2bbbad;
        }
        .btn-stop {
            background: #ef5350;
        }
        .btn-stop:hover {
            background: #ff6b68;
        }
        .main-container {
            display: flex;
            height: calc(100vh - 70px);
        }
        #chart-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 10px;
        }
        .timeframe-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }
        .tf-tab {
            padding: 8px 20px;
            background: #1a1a2e;
            border: 1px solid #4cc9f0;
            border-radius: 4px;
            color: #4cc9f0;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            transition: all 0.2s;
        }
        .tf-tab:hover {
            background: #0f3460;
        }
        .tf-tab.active {
            background: #4cc9f0;
            color: #0f0f23;
        }
        #chart-container {
            flex: 1;
            position: relative;
        }
        .chart-wrapper {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #1a1a2e;
            border-radius: 8px;
            overflow: hidden;
            display: none;
        }
        .chart-wrapper.visible {
            display: block;
        }
        .chart-wrapper .chart {
            width: 100%;
            height: 100%;
        }
        .chart-label {
            position: absolute;
            top: 5px;
            left: 10px;
            background: rgba(22, 33, 62, 0.9);
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.75rem;
            color: #4cc9f0;
            z-index: 10;
            font-weight: bold;
        }
        .chart-wrapper.active {
            outline: 2px solid #4cc9f0;
        }
        .info-bar {
            position: absolute;
            top: 90px;
            left: 20px;
            background: rgba(22, 33, 62, 0.9);
            padding: 10px 15px;
            border-radius: 4px;
            font-size: 0.85rem;
            z-index: 100;
        }
        .info-bar .price {
            font-size: 1.1rem;
            font-weight: bold;
        }
        .info-bar .up { color: #26a69a; }
        .info-bar .down { color: #ef5350; }
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2rem;
            color: #4cc9f0;
        }
        .error {
            color: #ef5350;
            padding: 20px;
            text-align: center;
        }

        /* Collector Panel */
        .collector-panel {
            width: 350px;
            background: #16213e;
            border-left: 1px solid #2B2B43;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        .panel-section {
            padding: 15px;
            border-bottom: 1px solid #2B2B43;
        }
        .panel-section h3 {
            color: #4cc9f0;
            font-size: 0.95rem;
            margin-bottom: 12px;
        }
        .status-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        .status-item {
            background: #0f3460;
            padding: 8px 12px;
            border-radius: 4px;
        }
        .status-item .label {
            font-size: 0.75rem;
            color: #888;
        }
        .status-item .value {
            font-size: 1rem;
            font-weight: bold;
        }
        .status-running { color: #26a69a; }
        .status-stopped { color: #ef5350; }

        /* Recent Sessions */
        .recent-data {
            max-height: 200px;
            overflow-y: auto;
        }
        .data-item {
            background: #0f3460;
            padding: 8px 10px;
            border-radius: 4px;
            margin-bottom: 6px;
            font-size: 0.85rem;
        }
        .data-item .action-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-right: 8px;
        }
        .action-BUY { background: #26a69a; }
        .action-SELL { background: #4cc9f0; }
        .action-STOP_LOSS { background: #ef5350; }
        .action-HOLD { background: #555; }
        .data-item .thought-preview {
            color: #888;
            font-size: 0.8rem;
            margin-top: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

    </style>
</head>
<body>
    <div class="header">
        <h1>MT5 Trader思考解析 & 売買システム</h1>
        <div class="controls">
            <div class="control-group">
                <label>銘柄:</label>
                <select id="symbol">
                    <option value="XAUUSDp">XAUUSDp</option>
                </select>
            </div>
            <div class="control-group">
                <label>本数:</label>
                <input type="number" id="count" value="100" min="10" max="500" style="width: 80px;">
            </div>
            <button id="loadBtn">更新</button>
            <button id="loadHLinesBtn" onclick="loadHorizontalLinesFromMT5()" style="background: #ff9800;">MT5水平線を読込</button>
            <span style="color: #888; font-size: 0.8rem; margin-left: 10px;">表示: H4 / M15 / M5 / M1</span>
        </div>
    </div>

    <div class="main-container">
        <div class="info-bar" id="infoBar">
            <span id="symbolInfo">XAUUSDp</span> |
            <span id="priceInfo" class="price">---</span>
        </div>


        <div id="chart-area">
            <div class="timeframe-tabs">
                <button class="tf-tab active" data-tf="H4" onclick="showTimeframe('H4')">H4</button>
                <button class="tf-tab" data-tf="M15" onclick="showTimeframe('M15')">M15</button>
                <button class="tf-tab" data-tf="M5" onclick="showTimeframe('M5')">M5</button>
                <button class="tf-tab" data-tf="M1" onclick="showTimeframe('M1')">M1</button>
                <span id="horizontalLineStatus" style="margin-left: auto; font-size: 0.75rem; color: #888;"></span>
            </div>
            <div id="chart-container">
                <div class="chart-wrapper visible active" data-timeframe="H4">
                    <div class="chart-label">4時間足 (H4)</div>
                    <div class="chart" id="chart-H4"></div>
                </div>
                <div class="chart-wrapper" data-timeframe="M15">
                    <div class="chart-label">15分足 (M15)</div>
                    <div class="chart" id="chart-M15"></div>
                </div>
                <div class="chart-wrapper" data-timeframe="M5">
                    <div class="chart-label">5分足 (M5)</div>
                    <div class="chart" id="chart-M5"></div>
                </div>
                <div class="chart-wrapper" data-timeframe="M1">
                    <div class="chart-label">1分足 (M1)</div>
                    <div class="chart" id="chart-M1"></div>
                </div>
            </div>
        </div>

        <div class="collector-panel">
            <!-- Session Section -->
            <div class="panel-section">
                <h3>セッション管理</h3>
                <div style="background: #2B2B43; padding: 8px; border-radius: 4px; margin-bottom: 10px; font-size: 0.75rem; color: #ff9800; line-height: 1.4;">
                    ⚠️ このシステムはデータ記録のみです。MT5での自動売買は行いません。実際の売買はMT5で手動で行ってください。
                </div>
                <div class="status-grid">
                    <div class="status-item" style="grid-column: span 2;">
                        <div class="label">セッション状態</div>
                        <div class="value" id="sessionStatus">なし</div>
                    </div>
                </div>
                <div class="session-thought-input" style="margin-top: 10px;">
                    <textarea id="sessionThoughtInput" placeholder="この判断の理由を入力...&#10;例: 15分足でダブルボトム確認、1分足でリテスト発生" style="background: #0f3460; border: 1px solid #4cc9f0; color: #fff; padding: 10px; border-radius: 4px; font-size: 0.9rem; resize: vertical; width: 100%; min-height: 80px; box-sizing: border-box;"></textarea>
                </div>
                <div class="session-controls" style="display: flex; flex-direction: column; gap: 8px; margin-top: 10px;">
                    <button class="btn-start" id="sessionStartBtn" onclick="startSession()" style="width: 100%;">BUY エントリー開始</button>
                    <button id="sessionHoldBtn" onclick="addSessionHold()" disabled style="width: 100%; background: #555;">HOLD 記録</button>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn-stop" id="sessionSellBtn" onclick="endSession('SELL')" disabled style="flex: 1;">SELL 決済</button>
                        <button style="flex: 1; background: #ff9800;" id="sessionStopLossBtn" onclick="endSession('STOP_LOSS')" disabled>STOP_LOSS</button>
                    </div>
                </div>
            </div>

            <!-- Recent Sessions Section -->
            <div class="panel-section">
                <h3 style="display: flex; justify-content: space-between; align-items: center;">
                    最近のセッション
                    <a href="/sessions" style="font-size: 0.75rem; color: #4cc9f0; text-decoration: none;">全て表示 ></a>
                </h3>
                <div class="recent-data" id="recentData">
                    <!-- Recent sessions will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <div class="loading" id="loading" style="display: none;">読み込み中...</div>

    <script>
        // Multi-chart state
        const TIMEFRAMES = ['H4', 'M15', 'M5', 'M1'];
        let charts = {}; // { H4: { chart, candleSeries, volumeSeries, drawnLines } }
        let activeTimeframe = 'H4';
        let ws = null;
        let statusInterval = null;


        // チャート初期化（複数チャート対応）
        function initChart() {
            TIMEFRAMES.forEach(tf => {
                const container = document.getElementById(`chart-${tf}`);
                const wrapper = container.parentElement;

                const chart = LightweightCharts.createChart(container, {
                    layout: {
                        background: { type: 'solid', color: '#1a1a2e' },
                        textColor: '#d1d4dc',
                    },
                    grid: {
                        vertLines: { color: '#2B2B43' },
                        horzLines: { color: '#2B2B43' },
                    },
                    crosshair: {
                        mode: LightweightCharts.CrosshairMode.Normal,
                    },
                    rightPriceScale: {
                        borderColor: '#2B2B43',
                    },
                    timeScale: {
                        borderColor: '#2B2B43',
                        timeVisible: true,
                        secondsVisible: false,
                    },
                });

                // ローソク足シリーズ
                const candleSeries = chart.addCandlestickSeries({
                    upColor: '#26a69a',
                    downColor: '#ef5350',
                    borderDownColor: '#ef5350',
                    borderUpColor: '#26a69a',
                    wickDownColor: '#ef5350',
                    wickUpColor: '#26a69a',
                });

                // 出来高シリーズ
                const volumeSeries = chart.addHistogramSeries({
                    color: '#4cc9f0',
                    priceFormat: {
                        type: 'volume',
                    },
                    priceScaleId: '',
                    scaleMargins: {
                        top: 0.85,
                        bottom: 0,
                    },
                });

                // クロスヘア移動時の情報更新
                chart.subscribeCrosshairMove((param) => {
                    if (param.time && param.seriesData.get(candleSeries)) {
                        const data = param.seriesData.get(candleSeries);
                        updatePriceInfo(data, tf);
                    }
                });

                // チャート情報を保存
                charts[tf] = {
                    chart,
                    candleSeries,
                    volumeSeries,
                    drawnLines: [],
                    container,
                    wrapper
                };

                // クリックでアクティブチャート切り替え
                wrapper.addEventListener('click', () => {
                    setActiveChart(tf);
                });
            });

            // リサイズ対応
            window.addEventListener('resize', () => {
                TIMEFRAMES.forEach(tf => {
                    const { chart, container } = charts[tf];
                    chart.applyOptions({
                        width: container.clientWidth,
                        height: container.clientHeight,
                    });
                });
            });
        }

        // アクティブチャート切り替え
        function setActiveChart(tf) {
            activeTimeframe = tf;
            document.querySelectorAll('.chart-wrapper').forEach(w => {
                w.classList.remove('active');
            });
            charts[tf].wrapper.classList.add('active');
        }

        // 時間足タブ切り替え
        function showTimeframe(tf) {
            activeTimeframe = tf;

            // タブボタンのactive切り替え
            document.querySelectorAll('.tf-tab').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tf === tf) {
                    btn.classList.add('active');
                }
            });

            // チャートの表示/非表示切り替え
            document.querySelectorAll('.chart-wrapper').forEach(w => {
                w.classList.remove('visible', 'active');
            });
            charts[tf].wrapper.classList.add('visible', 'active');

            // チャートサイズを再計算してスケールをフィット
            setTimeout(() => {
                const container = charts[tf].container;
                charts[tf].chart.applyOptions({
                    width: container.clientWidth,
                    height: container.clientHeight
                });
                charts[tf].chart.timeScale().fitContent();
            }, 50);
        }

        // 価格情報更新
        function updatePriceInfo(data, tf = null) {
            const priceInfo = document.getElementById('priceInfo');
            const change = data.close - data.open;
            const changeClass = change >= 0 ? 'up' : 'down';
            const sign = change >= 0 ? '+' : '';
            const tfLabel = tf ? `[${tf}] ` : '';

            priceInfo.innerHTML = `
                ${tfLabel}O: ${data.open.toFixed(2)}
                H: ${data.high.toFixed(2)}
                L: ${data.low.toFixed(2)}
                C: <span class="${changeClass}">${data.close.toFixed(2)} (${sign}${change.toFixed(2)})</span>
            `;
        }

        // 銘柄一覧を取得
        async function loadSymbols() {
            try {
                const res = await fetch('/api/symbols');
                const data = await res.json();
                const select = document.getElementById('symbol');
                select.innerHTML = '';
                data.symbols.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s;
                    option.textContent = s;
                    // XAUUSD または XAUUSDp を初期選択
                    if (s === 'XAUUSD' || s === 'XAUUSDp') option.selected = true;
                    select.appendChild(option);
                });
            } catch (e) {
                console.error('銘柄取得エラー:', e);
            }
        }

        // OHLCデータを取得してチャート更新（全4チャート）
        async function loadOHLC() {
            const symbol = document.getElementById('symbol').value;
            const count = document.getElementById('count').value;

            document.getElementById('loading').style.display = 'block';
            document.getElementById('loadBtn').disabled = true;

            try {
                // 全4時間足のデータを並列取得
                const promises = TIMEFRAMES.map(tf =>
                    fetch(`/api/ohlc?symbol=${symbol}&timeframe=${tf}&count=${count}`)
                        .then(res => res.json())
                        .then(data => ({ tf, data }))
                );

                const results = await Promise.all(promises);
                let hasData = false;

                results.forEach(({ tf, data }) => {
                    if (data.data && data.data.length > 0) {
                        hasData = true;
                        const chartObj = charts[tf];

                        // 既存の水平線をクリア
                        chartObj.drawnLines.forEach(line => {
                            try { chartObj.candleSeries.removePriceLine(line.lineObj); } catch(e) {}
                        });
                        chartObj.drawnLines = [];

                        // ローソク足データをセット
                        chartObj.candleSeries.setData(data.data);

                        // 出来高データをセット
                        const volumeData = data.data.map(d => ({
                            time: d.time,
                            value: d.volume,
                            color: d.close >= d.open ? '#26a69a50' : '#ef535050',
                        }));
                        chartObj.volumeSeries.setData(volumeData);

                        // チャートをフィット
                        chartObj.chart.timeScale().fitContent();
                    }
                });

                // 銘柄名更新
                document.getElementById('symbolInfo').textContent = symbol;

                if (!hasData) {
                    alert('データが取得できませんでした。MT5が起動しているか確認してください。');
                }
            } catch (e) {
                console.error('データ取得エラー:', e);
                alert('エラーが発生しました: ' + e.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('loadBtn').disabled = false;
            }
        }

        // ============ MT5 Horizontal Lines Functions ============

        // MT5水平線を保持する変数
        let mt5HorizontalLines = [];

        // MT5から水平線を読み込む（手動ボタン）
        async function loadHorizontalLinesFromMT5() {
            const btn = document.getElementById('loadHLinesBtn');
            btn.disabled = true;
            btn.textContent = '読込中...';

            try {
                const res = await fetch('/api/horizontal-lines');
                const data = await res.json();

                // ハッシュ更新（自動更新と同期）
                lastHorizontalLinesHash = JSON.stringify(data.lines || []);

                // 既存のMT5水平線をクリア
                clearMT5HorizontalLines();

                // 水平線があれば描画
                if (data.lines && data.lines.length > 0) {
                    data.lines.forEach(line => {
                        TIMEFRAMES.forEach(tf => {
                            const chartObj = charts[tf];
                            const priceLine = chartObj.candleSeries.createPriceLine({
                                price: line.price,
                                color: line.color || '#FF9800',
                                lineWidth: 2,
                                lineStyle: LightweightCharts.LineStyle.Solid,
                                axisLabelVisible: true,
                                title: line.name || ''
                            });

                            mt5HorizontalLines.push({
                                tf: tf,
                                lineObj: priceLine,
                                price: line.price,
                                name: line.name
                            });
                        });
                    });
                }

                // ステータス更新
                const statusEl = document.getElementById('horizontalLineStatus');
                if (statusEl) {
                    const now = new Date().toLocaleTimeString('ja-JP');
                    statusEl.textContent = `MT5水平線: ${data.lines?.length || 0}本 (${now})`;
                    statusEl.style.color = data.lines?.length > 0 ? '#4cc9f0' : '#888';
                }

                console.log(`MT5水平線を読み込みました: ${data.lines?.length || 0}本`);

            } catch (e) {
                console.error('MT5水平線読み込みエラー:', e);
                const statusEl = document.getElementById('horizontalLineStatus');
                if (statusEl) {
                    statusEl.textContent = 'MT5水平線: エラー';
                    statusEl.style.color = '#ef5350';
                }
            } finally {
                btn.disabled = false;
                btn.textContent = 'MT5水平線を読込';
            }
        }

        // MT5水平線をクリア
        function clearMT5HorizontalLines() {
            mt5HorizontalLines.forEach(line => {
                try {
                    charts[line.tf].candleSeries.removePriceLine(line.lineObj);
                } catch (e) {
                    // 既に削除済みの場合は無視
                }
            });
            mt5HorizontalLines = [];
        }

        // MT5水平線の自動更新（5秒毎）
        let lastHorizontalLinesHash = '';
        async function autoLoadHorizontalLines() {
            try {
                const res = await fetch('/api/horizontal-lines');
                const data = await res.json();

                // ハッシュ計算（変更検知用）
                const currentHash = JSON.stringify(data.lines || []);
                if (currentHash === lastHorizontalLinesHash) {
                    // 変更なし
                    return;
                }
                lastHorizontalLinesHash = currentHash;

                // 既存のMT5水平線をクリア
                clearMT5HorizontalLines();

                // 水平線があれば描画
                if (data.lines && data.lines.length > 0) {
                    data.lines.forEach(line => {
                        TIMEFRAMES.forEach(tf => {
                            const chartObj = charts[tf];
                            const priceLine = chartObj.candleSeries.createPriceLine({
                                price: line.price,
                                color: line.color || '#FF9800',
                                lineWidth: 2,
                                lineStyle: LightweightCharts.LineStyle.Solid,
                                axisLabelVisible: true,
                                title: line.name || ''
                            });

                            mt5HorizontalLines.push({
                                tf: tf,
                                lineObj: priceLine,
                                price: line.price,
                                name: line.name
                            });
                        });
                    });
                }

                // ステータス更新
                const statusEl = document.getElementById('horizontalLineStatus');
                if (statusEl) {
                    const now = new Date().toLocaleTimeString('ja-JP');
                    statusEl.textContent = `MT5水平線: ${data.lines?.length || 0}本 (${now})`;
                    statusEl.style.color = data.lines?.length > 0 ? '#4cc9f0' : '#888';
                }

            } catch (e) {
                console.error('水平線自動更新エラー:', e);
                const statusEl = document.getElementById('horizontalLineStatus');
                if (statusEl) {
                    statusEl.textContent = 'MT5水平線: 接続エラー';
                    statusEl.style.color = '#ef5350';
                }
            }
        }

        // ============ Session Functions ============

        // セッション状態を更新
        async function updateSessionStatus() {
            try {
                const res = await fetch('/api/sessions/active');
                const data = await res.json();

                const statusEl = document.getElementById('sessionStatus');
                const startBtn = document.getElementById('sessionStartBtn');
                const holdBtn = document.getElementById('sessionHoldBtn');
                const sellBtn = document.getElementById('sessionSellBtn');
                const stopLossBtn = document.getElementById('sessionStopLossBtn');

                if (data.session) {
                    statusEl.textContent = `${data.session.session_id} (${data.session.status})`;
                    statusEl.className = 'value status-running';
                    startBtn.disabled = true;
                    holdBtn.disabled = false;
                    holdBtn.style.background = '#4cc9f0';
                    sellBtn.disabled = false;
                    stopLossBtn.disabled = false;
                } else {
                    statusEl.textContent = 'なし';
                    statusEl.className = 'value';
                    startBtn.disabled = false;
                    holdBtn.disabled = true;
                    holdBtn.style.background = '#555';
                    sellBtn.disabled = true;
                    stopLossBtn.disabled = true;
                }
            } catch (e) {
                console.error('Session status update error:', e);
            }
        }

        // セッション開始（BUY）
        async function startSession() {
            const thought = document.getElementById('sessionThoughtInput').value.trim();
            if (!thought) {
                alert('思考を入力してください');
                return;
            }

            try {
                const res = await fetch('/api/sessions/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ thought })
                });
                const data = await res.json();
                console.log('Session started:', data);

                document.getElementById('sessionThoughtInput').value = '';
                await updateSessionStatus();
                await updateRecentSessions();
            } catch (e) {
                console.error('Start session error:', e);
                alert('セッションの開始に失敗しました');
            }
        }

        // HOLD追加
        async function addSessionHold() {
            const thought = document.getElementById('sessionThoughtInput').value.trim();
            if (!thought) {
                alert('思考を入力してください');
                return;
            }

            try {
                const res = await fetch('/api/sessions/hold', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ thought })
                });
                const data = await res.json();
                console.log('HOLD added:', data);

                document.getElementById('sessionThoughtInput').value = '';
                await updateSessionStatus();
                await updateRecentSessions();
            } catch (e) {
                console.error('Add hold error:', e);
                alert('HOLDの追加に失敗しました');
            }
        }

        // セッション終了（SELL/STOP_LOSS）
        async function endSession(action) {
            const thought = document.getElementById('sessionThoughtInput').value.trim();
            if (!thought) {
                alert('思考を入力してください');
                return;
            }

            try {
                const res = await fetch('/api/sessions/end', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, thought })
                });
                const data = await res.json();
                console.log('Session ended:', data);

                document.getElementById('sessionThoughtInput').value = '';
                await updateSessionStatus();
                await updateRecentSessions();
            } catch (e) {
                console.error('End session error:', e);
                alert('セッションの終了に失敗しました');
            }
        }

        // ============ Recent Sessions ============

        // 最近のセッション履歴を更新
        async function updateRecentSessions() {
            try {
                const res = await fetch('/api/sessions?limit=5');
                const data = await res.json();
                const container = document.getElementById('recentData');

                if (data.sessions && data.sessions.length > 0) {
                    container.innerHTML = data.sessions.map(session => {
                        const resultClass = session.result?.profit >= 0 ? 'profit' : 'loss';
                        const resultText = session.result
                            ? `${session.result.profit >= 0 ? '+' : ''}${session.result.profit.toFixed(2)}`
                            : session.status;
                        return `
                            <div class="data-item" style="cursor: pointer;" onclick="window.location='/sessions'">
                                <span class="action-badge action-${session.status === 'completed' ? 'SELL' : 'BUY'}">${session.status}</span>
                                <span>${session.session_id}</span>
                                <span style="margin-left: auto; color: ${resultClass === 'profit' ? '#26a69a' : '#ef5350'};">${resultText}</span>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<p style="color: #888; font-size: 0.85rem;">まだセッションがありません</p>';
                }
            } catch (e) {
                console.error('Recent sessions update error:', e);
            }
        }

        // WebSocket接続
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws/collector`);

            ws.onopen = () => {
                console.log('WebSocket connected');
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('WebSocket message:', data);

                if (data.type === 'action_detected') {
                    // アクション検出時の通知
                    updatePendingActions();
                    // 通知音を鳴らす（オプション）
                    // new Audio('/notification.mp3').play();
                } else if (data.type === 'thought_submitted') {
                    updateRecentSessions();
                }
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected, reconnecting...');
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', async () => {
            initChart();
            await loadSymbols();
            await loadOHLC();

            // セッション状態の初期化
            await updateSessionStatus();
            await updateRecentSessions();

            // MT5水平線の自動更新開始（5秒毎）
            await autoLoadHorizontalLines();  // 初回実行
            setInterval(autoLoadHorizontalLines, 5000);  // 5秒毎に更新

            // WebSocket接続
            connectWebSocket();

            // イベントリスナー
            document.getElementById('loadBtn').addEventListener('click', loadOHLC);
            document.getElementById('symbol').addEventListener('change', loadOHLC);
        });
    </script>
</body>
</html>
